---
import type { Friend } from '../config/social';
import { SocialLinks } from './social';

export interface Props {
  friend: Friend;
}

import { getGithubAvatar, getGithubUsername } from '../utils';

const { friend } = Astro.props;

function getNameColor(name: string): string {
  const colors = [
    'text-amber-600',
    'text-blue-600',
    'text-emerald-600',
    'text-indigo-600',
    'text-rose-600',
    'text-cyan-600',
    'text-violet-600',
    'text-teal-600',
  ];
  let hash = 0;
  for (let i = 0; i < name.length; i++) {
    hash = name.charCodeAt(i) + ((hash << 5) - hash);
  }
  return colors[Math.abs(hash) % colors.length];
}

function getInitial(name: string): string {
  return name.charAt(0).toUpperCase();
}

const githubUsername = getGithubUsername(friend.socialLinks);
const avatarUrl = githubUsername ? getGithubAvatar(githubUsername) : null;
const nameColor = getNameColor(friend.name);
---

<div class="flex gap-0">
  {/* Avatar */}
  <div class="flex-shrink-0 self-end mb-0.5 z-10">
    <div class="w-10 h-10 rounded-full bg-gray-200 flex items-center justify-center text-sm font-semibold text-gray-600 select-none overflow-hidden shadow-sm">
      {
        avatarUrl ? (
          <img
            src={avatarUrl}
            alt={friend.name}
            class="w-full h-full object-cover"
            loading="lazy"
            onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"
          />
        ) : null
      }
      <span
        class={avatarUrl
          ? 'hidden w-full h-full items-center justify-center bg-gradient-to-br from-gray-100 to-gray-200'
          : 'flex w-full h-full items-center justify-center bg-gradient-to-br from-gray-100 to-gray-200'}
      >
        {getInitial(friend.name)}
      </span>
    </div>
  </div>

  {/* Bubble */}
  <div class="flex-1 min-w-0 relative -ml-1">
    {/* Tail */}
    <div class="absolute left-0 bottom-0 w-[20px] h-[20px] z-10">
      <svg
        viewBox="0 0 11 20"
        width="11"
        height="20"
        class="absolute bottom-[0px] right-0 w-[11px] h-[20px] overflow-visible"
      >
        <path
          d="M12 0 L11 0 C11 17 6 20 0 20 L11 20 L12 20 Z"
          fill="white"
        />
        <path
          d="M11 0 C11 17 6 20 0 20 L11 20"
          fill="none"
          stroke="#e5e7eb"
          stroke-width="1"
        />
      </svg>
    </div>

    <div class="relative bg-white rounded-2xl rounded-bl-none shadow-sm border border-gray-200 px-4 py-3 ml-5">
      {/* Header: Name and Social Links */}
      <div class="flex items-start justify-between gap-3 mb-1">
        <h3 class={`font-semibold text-[15px] ${nameColor}`}>
          {friend.name}
        </h3>
        <div class="flex-shrink-0 -mr-1 -mt-0.5">
          <SocialLinks
            links={friend.socialLinks}
            size="sm"
            className="gap-1.5"
          />
        </div>
      </div>

      {/* Description */}
      {
        friend.description && (
          <p class="text-gray-800 text-[15px] leading-snug">
            {friend.description}
          </p>
        )
      }
    </div>
  </div>
</div>
