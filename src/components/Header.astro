---
const pathname = Astro.url.pathname;

function normalizePath(path: string) {
  // Astro dev/prod may differ by trailing slash (e.g. /notes vs /notes/).
  // Normalize so active nav highlighting is stable.
  const raw = path.split('?')[0]?.split('#')[0] || '/';
  if (raw === '/') return '/';
  return raw.endsWith('/') ? raw.slice(0, -1) : raw;
}

function isActive(current: string, target: string) {
  const normalizedCur = normalizePath(current);
  const normalizedTgt = normalizePath(target);
  return (
    normalizedCur === normalizedTgt
    || (normalizedTgt !== '/' && normalizedTgt !== ''
      && normalizedCur.startsWith(normalizedTgt))
  );
}

const navItems = [
  { name: 'Home', href: '/', icon: 'i-tabler-home' },
  { name: 'Posts', href: '/posts', icon: 'i-tabler-article' },
  { name: 'Notes', href: '/notes', icon: 'i-tabler-note' },
  { name: 'About', href: '/about', icon: 'i-tabler-user' },
  { name: 'Friends', href: '/friends', icon: 'i-tabler-users' },
] as const;

const activeLinkClass = 'text-accent-600';
const inactiveLinkClass =
  'text-gray-600 hover:text-gray-900 hover:bg-gray/20 rounded-md';
const desktopLinkBaseClass =
  'group relative flex items-center gap-1 px-1 py-1 text-sm font-normal transition-all duration-300';
const mobileLinkBaseClass =
  'mobile-menu-link relative flex items-center gap-2.5 px-3 py-1.5 text-sm font-normal transition-all duration-300';
---

<header
  id="header"
  class="w-full bg-white/40 backdrop-blur-md sticky top-0 z-50 transition-all duration-300"
>
  <div class="max-w-6xl mx-auto px-6 py-1.5">
    <div class="flex items-center justify-between">
      <a class="flex items-center gap-4 hover:text-gray-900" href="/">Artea</a>

      <nav class="hidden md:flex items-center gap-2">
        {
          navItems.map((item) => {
            const active = isActive(pathname, item.href);
            return (
            <a
              href={item.href}
              aria-current={active ? 'page' : undefined}
              class={`${desktopLinkBaseClass} ${
                active ? activeLinkClass : inactiveLinkClass
              }`}
            >
              <span
                class={`${item.icon} text-base transition-transform duration-300`}
              />
              <span>{item.name}</span>
            </a>
          );
          })
        }
      </nav>

      <button
        id="mobile-menu-button"
        class="md:hidden flex items-center justify-center w-8 h-8 rounded-lg bg-white/40 hover:bg-white/60 transition-all duration-300"
        aria-label="Open menu"
        aria-expanded="false"
        aria-controls="mobile-menu"
      >
        <span
          id="menu-icon"
          class="i-tabler-menu-2 text-base text-gray-600 transition-transform duration-300"
        ></span>
      </button>
    </div>
  </div>

  <div id="mobile-menu" class="hidden md:hidden bg-white/40 backdrop-blur-md">
    <nav class="max-w-6xl mx-auto px-6 py-1.5 space-y-0.5">
      {
        navItems.map((item) => {
          const active = isActive(pathname, item.href);
          return (
          <a
            href={item.href}
            aria-current={active ? 'page' : undefined}
            class={`${mobileLinkBaseClass} ${
              active ? activeLinkClass : inactiveLinkClass
            }`}
          >
            <span class={`${item.icon} text-base`} />
            <span>{item.name}</span>
          </a>
        );
        })
      }
    </nav>
  </div>
</header>

<script>
function initHeader() {
  const menuButtonEl = document.getElementById('mobile-menu-button');
  const mobileMenuEl = document.getElementById('mobile-menu');
  const menuIconEl = document.getElementById('menu-icon');
  const headerEl = document.getElementById('header');

  if (
    !(menuButtonEl instanceof HTMLButtonElement)
    || !(mobileMenuEl instanceof HTMLElement)
    || !(menuIconEl instanceof HTMLElement)
    || !(headerEl instanceof HTMLElement)
  ) {
    return;
  }

  const menuButton = menuButtonEl;
  const mobileMenu = mobileMenuEl;
  const menuIcon = menuIconEl;
  const header = headerEl;

  const ICON_BASE = 'text-base text-gray-600 transition-transform duration-300';
  const ICONS = {
    open: `i-tabler-x ${ICON_BASE}`,
    closed: `i-tabler-menu-2 ${ICON_BASE}`,
  };

  const HEADER_BG_DEFAULT = 'bg-white/40';
  const HEADER_BG_SCROLLED = 'bg-white/70';
  const HEADER_SCROLLED_EXTRAS = ['border-b', 'border-white/20', 'shadow-sm'];

  const mqDesktop = window.matchMedia('(min-width: 768px)');
  let isMenuOpen = false;

  function setMenuState(open: boolean) {
    isMenuOpen = open;
    mobileMenu.classList.toggle('hidden', !open);
    menuIcon.className = open ? ICONS.open : ICONS.closed;
    menuButton.setAttribute('aria-expanded', String(open));
    menuButton.setAttribute(
      'aria-label',
      open ? 'Close menu' : 'Open menu',
    );
  }

  function toggleMenu() {
    setMenuState(!isMenuOpen);
  }

  function updateHeaderOnScroll() {
    const scrolled = window.scrollY > 10;
    if (scrolled) {
      header.classList.remove(HEADER_BG_DEFAULT);
      header.classList.add(HEADER_BG_SCROLLED, ...HEADER_SCROLLED_EXTRAS);
    } else {
      header.classList.remove(HEADER_BG_SCROLLED, ...HEADER_SCROLLED_EXTRAS);
      header.classList.add(HEADER_BG_DEFAULT);
    }
  }

  function onMobileLinkClick() {
    setMenuState(false);
  }

  function onDocumentClick(e: MouseEvent) {
    if (!isMenuOpen) return;
    const target = e.target;
    if (target instanceof Node && !header.contains(target)) {
      setMenuState(false);
    }
  }

  function onDocumentKeydown(e: KeyboardEvent) {
    if (e.key === 'Escape') {
      setMenuState(false);
    }
  }

  function onMediaChange() {
    // When switching to desktop layout, ensure mobile menu is closed.
    if (mqDesktop.matches) {
      setMenuState(false);
    }
  }

  // Initialize
  setMenuState(false);
  updateHeaderOnScroll();

  menuButton.addEventListener('click', toggleMenu);
  const mobileLinks = Array.from(
    document.querySelectorAll<HTMLAnchorElement>('.mobile-menu-link'),
  );
  mobileLinks.forEach((link) =>
    link.addEventListener('click', onMobileLinkClick)
  );
  document.addEventListener('click', onDocumentClick);
  document.addEventListener('keydown', onDocumentKeydown);
  window.addEventListener('scroll', updateHeaderOnScroll, { passive: true });
  mqDesktop.addEventListener('change', onMediaChange);

  return () => {
    menuButton.removeEventListener('click', toggleMenu);
    mobileLinks.forEach((link) =>
      link.removeEventListener('click', onMobileLinkClick)
    );
    document.removeEventListener('click', onDocumentClick);
    document.removeEventListener('keydown', onDocumentKeydown);
    window.removeEventListener('scroll', updateHeaderOnScroll);
    mqDesktop.removeEventListener('change', onMediaChange);
  };
}

let cleanup: (() => void) | undefined;

function setupHeader() {
  if (cleanup) cleanup();
  cleanup = initHeader();
}

setupHeader();
document.addEventListener('astro:page-load', setupHeader);
document.addEventListener('astro:after-swap', setupHeader);
</script>
